---
title: "AMF colonisation"
author: "zagor"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: true
      smooth_scroll: true
    fig_caption: yes
    self_contained: yes
    fig_width: 3
    fig_height: 4
    number_sections: yes
    theme: flatly
    highlight: tango
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}

knitr::opts_chunk$set(#dev = c('pdf', 'png'),
                      dev = c('png', 'svg', 'pdf'), 
                      fig.align = 'center', 
                      fig.height = 4, 
                      fig.width = 3,
                      warning = FALSE, message = FALSE, echo = TRUE
                      )


```


```{r}

rm(list = ls(all = TRUE))
gc()


```


# packages

```{r, libs}


# %>% 
library(magrittr)
library(ggplot2)
library(emmeans)
library(multcomp)  # This must come after emmeans

`%!in%` = Negate(`%in%`)



```


# palette
```{r}

col = RColorBrewer::brewer.pal(8, 'Paired')[c(3,5,7)]


```

# params

```{r, reports}

my_dir = file.path("..", "reports", "AMFcolonisation")
if (!dir.exists(my_dir)) {
  dir.create(my_dir)
}

dodge = position_dodge(width = 0.5)
p = rev(col)


```


# input


```{r, input}

fp = file.path('..', 'input')

fn = 'Table_combinedInputs.xlsx'
wb = openxlsx::loadWorkbook(file.path(fp, fn))
sheet_names = names(wb)
sheet_name = grep("AMFcolonisation", sheet_names, value = TRUE)

df = openxlsx::read.xlsx(file.path(fp, fn), sheet = sheet_name, startRow = 10)
df = df[df$Time.point == '4wpi', ]

df$Genotype = factor(df$Genotype, levels = c('NT', 'L2', 'L6'))
df$perc = df$Percentage.root.lenght.colonized/100
df$group = df$Genotype

```

# summary statistics

```{r, summary}

df.SE = df[, c(1,5)] %>% dplyr::group_by(Genotype) %>% 
  dplyr::summarise_each(list(mean = mean, sd = sd, se = plotrix::std.error))
print(df.SE)

```


# hypothesis test for two means of percentages

- performs a two-sample test for proportions (like a t-test for percentages), assuming beta-distributed data
- must manually run for each pair

```{r, perctest}

Rfast::percent.ttest(df[df$Genotype == 'NT', ]$Percentage.root.lenght.colonized/100,
                     df[df$Genotype == 'L2', ]$Percentage.root.lenght.colonized/100,
                     logged = FALSE)
Rfast::percent.ttest(df[df$Genotype == 'NT', ]$Percentage.root.lenght.colonized/100,
                     df[df$Genotype == 'L6', ]$Percentage.root.lenght.colonized/100,
logged = FALSE)

```


# beta regression 

- analysing percentage data using beta regression followed by estimated marginal means (EMMs) and pairwise comparisons
- Beta regression is well-suited for modelling data bounded between 0 and 1 (i.e., proportions or percentages)
- Joint Tests is useful for testing whether the factor Genotype has a significant overall effect
- Estimated Marginal Means -- EMMs are interpretable as model-adjusted group means
- Sidak adjustment for controlling family-wise error rate - adjusts p-values or alpha levels for multiple comparisons; Dunnettx is designed for one-vs-control comparisons and is more statistically powerful in that context; 


```{r, betareg}

model = betareg::betareg(perc ~ Genotype,
                data = df)

# Compute joint tests of the terms in a model
emmeans::joint_tests(model)

# Estimated marginal means (Least-squares means)
# Compute estimated marginal means (EMMs) for specified factors or factor combinations in a linear model; and optionally, comparisons or contrasts among them. EMMs are also known as least-squares means.
marginal = emmeans::emmeans(model,
                   ~ Genotype)

# pair-wise comparisons
pairs(marginal,
      adjust="Sidak")


# Set up a compact letter display of all pair-wise comparisons against control
cld = multcomp::cld(marginal,
              alpha=0.05,
              Letters=letters,      ### Use lower-case letters for .group
              adjust="dunnettx")    ### adjusted comparisons 
print(cld)




```


# plot groups

visualization of comparisons using ggplot

```{r}

title = ''

ggplot(data=df, aes(x=Genotype, y=perc,col=Genotype))+
  geom_boxplot(aes(fill=Genotype), alpha = 0.5) +
  theme_bw() +
  geom_text(data = cld, aes(label = .group, y = 0.26, x = Genotype), 
             vjust = -0.5,
             hjust= 0.5,
            fontface = "bold",
            size=3.5,
            check_overlap = F,
            colour = 'black') +
  theme(legend.position = "none") +
        ggtitle(title)  +
    theme_classic() +
      scale_colour_manual(name = NULL,
                          values = rev(p)) +
      scale_fill_manual(name = NULL,
                        values = rev(p)
                        ) + 
        labs(x = '', 
             y = 'Percentage root lenght colonized') + 
        scale_y_continuous(limits = c(0, NA),
                           breaks = seq(0, max(df$perc), 0.02),
                           labels = scales::percent
                           ) +
      theme(axis.text.x = element_text (angle = 0, # 45, 
                                        vjust = 1, 
                                        hjust = 1, 
                                        size = 12),
            axis.text.y = element_text (angle = 0, 
                                        vjust = 1, 
                                        hjust = 1, 
                                        size = 12),
            axis.title.x = element_text (angle = 0, # 45, 
                                        #vjust = 1, 
                                        #hjust = 1, 
                                        size = 12,
                                        face = "bold"),
            axis.title.y = element_text (angle =  90, 
                                        # vjust = 1, 
                                        # hjust = 1, 
                                        size = 12,
                                        face = "bold"),
            axis.text = element_text( angle = 0 # 90 
                                      ),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_blank(),
            panel.background = element_blank(),
            legend.position = "bottom",
            legend.background = element_rect(fill=NULL, 
                                             size=0.1, linetype="solid"),
            legend.title = element_text(color = NULL,
                                        size = 12,
                                        face = "bold"),
            legend.text = element_text( size = 12),
            axis.ticks = element_blank(),
            strip.text = element_text(size = 12,  face = "bold"),
            strip.background = element_blank()) + 
  guides(fill = "none") +
  guides(shape = "none") +
  guides(colour = "none") 




ggsave(
  filename = paste0(my_dir, '/fig1', '.pdf'),
  plot = last_plot(),
  device = pdf,
  path = NULL,
  scale = 1,
  width = 3,
  height = 5,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)

ggsave(
  filename = paste0(my_dir, '/fig1', '.svg'),
  plot = last_plot(),
  device = svg,
  path = NULL,
  scale = 1,
  width = 3,
  height = 5,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)





ggplot(df.SE, aes(x = Genotype, y = mean, fill = Genotype)) + # , pch = genotype)) +
    geom_point(aes(fill = Genotype), size=3.5, shape=22, position = dodge, colour = 'black') +
    geom_point(data = df, 
               aes(x = Genotype, y = perc, fill = Genotype), #, pch = genotype),
               size = 2.0, shape = 21, colour = 'black',
               position = dodge) +
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.3, lwd = 0.5,
                  position = dodge) + 
    geom_text(data = cld, aes(label = .group, y = 0.26, x = Genotype), 
             vjust = -0.5,
             hjust= 0.5,
            fontface = "bold",
            size=3.5,
            check_overlap = F,
            colour = 'black') +
    ggtitle('')  + 
    theme_bw() + 
    scale_colour_manual(name = "",
                        values = rev(p)) + 
      scale_fill_manual(name = "",
                        values = rev(p)) +
            labs(x = '', y = 'Percentage root lenght colonized',
                 subtitle = '') +
        scale_y_continuous(limits = c(0, NA),
                           breaks = seq(0, max(df$perc), 0.02),
                           labels = scales::percent
                           ) +
    theme( plot.subtitle = element_text( size = 10 ), 
           axis.text = element_text( size = 12.5 ),
           axis.text.x = element_text( size = 12.5, angle = 0 #90
                                       ),
           axis.title = element_text( size = 12.5, face = "bold" ),
           strip.text = element_text(size = 12.5),
           title = element_text( size = 15, face = "bold" ),
           axis.ticks.x = element_blank(),
           legend.key.height= unit(1.5, 'cm'),
           legend.key.width= unit(1.75, 'cm'),
           legend.text = element_text(size=12.5),
           legend.title = element_text(size=12.5),
           legend.background = element_rect(fill="transparent", size=.5, linetype="dotted"),
           legend.position="right",
           legend.justification = "right",
           plot.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),#,
          #panel.border = element_blank()
          axis.title.y.right = element_blank(),                # hide right axis title
          axis.text.y.right = element_blank(),                 # hide right axis labels
          axis.ticks.y = element_blank(),                      # hide left/right axis ticks
          axis.text.y = element_text(size = 12.5, margin = margin(r = 0)),  # move left axis labels closer to axis
          panel.spacing = unit(1, "lines"), # panel.spacing = unit(0, "mm"),                       # remove spacing between facets
          # strip.background = element_rect(size = 0.5, fill = "transparent"),         # match default line size of theme_classic
          # strip.background = element_blank() # hide facet outline
          # remove both the panel.border and panel.background to see the axis lines
          panel.border = element_blank(),
          # https://stackoverflow.com/questions/12883386/plotting-only-x-and-y-axis-borders-no-box-in-ggplot2
          axis.line = element_line()
           ) +
  guides(colour="none") + 
  guides(fill="none") + 
  # scale_fill_discrete(guide="none") + 
  # theme(legend.position="none")
  theme(legend.position="top")


ggsave(
  filename = paste0(my_dir, '/fig2', '.pdf'),
  plot = last_plot(),
  device = pdf,
  path = NULL,
  scale = 1,
  width = 3,
  height = 5,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)

ggsave(
  filename = paste0(my_dir, '/fig2', '.svg'),
  plot = last_plot(),
  device = svg,
  path = NULL,
  scale = 1,
  width = 3,
  height = 5,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)




```


# session info

```{r, sessionInfo}

sessionInfo()

```

